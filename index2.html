<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .panel {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            box-sizing: border-box;
        }
    </style>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>

<body>
    <div class="container">
        <div>test</div>
        <div class="panel">
            <button onclick="getItems()">Ëé∑Âèñ</button>
            <pre id="itemsResult"></pre>
        </div>
        <div class="panel">
            <label>ID: <input type="text" id="itemId"></label>
            <button onclick="buyItem()">goumai</button>
            <pre id="tradeResult"></pre>
        </div>
        <div class="panel">
            <label>Áî®Êà∑Âêç: <input type="text" id="username"></label>
            <label>ÂØÜÁ†Å: <input type="password" id="password"></label>
            <button onclick="login()">ÁôªÂΩï</button>
            <pre id="loginResult"></pre>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3005'; // Ê†πÊçÆ‰Ω†ÁöÑAPIÂú∞ÂùÄ‰øÆÊîπ
        const defaultHeaders = {
            ['x-app-id']: 'WEB_CLIENT',
        }
        let token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InRlc3QiLCJpZCI6NCwiYXBwX2lkIjoiV0VCX0NMSUVOVCIsImlhdCI6MTc1MTk1MzQ1OSwiZXhwIjoxNzUyMDM5ODU5fQ.gTz9RPaaTkcmV_T3DW_NwZOPQKeZ9qXNWBCcAzeR9tg';
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const appId = "WEB_CLIENT";

            try {
                const response = await fetch(`${API_BASE}/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, app_id: appId })
                });
                const data = await response.json();
                token = data.token || '';
                document.getElementById('loginResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('loginResult').textContent = 'ÈîôËØØ: ' + error.message;
            }
        }

        async function getItems() {
            const userId = 4;

            try {
                const response = await fetch(`${API_BASE}/inventory/list`, {
                    headers: { ...defaultHeaders, 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById('itemsResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('itemsResult').textContent = 'ÈîôËØØ: ' + error.message;
            }
        }

        async function buyItem() {
            const itemId = document.getElementById('itemId').value;

            try {
                const response = await fetch(`${API_BASE}/trade/buy/${itemId}`, {
                    method: 'POST',
                    headers: {
                        ...defaultHeaders,
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({count:1 })
                });
                const data = await response.json();
                document.getElementById('tradeResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('tradeResult').textContent = 'ÈîôËØØ: ' + error.message;
            }
        }
        const socket = io('http://localhost:3005', {
            path: '/ws',       // ÂåπÈÖçÊúçÂä°Á´ØË∑ØÂæÑ
            transports: ['websocket'], // Âº∫Âà∂‰ΩøÁî® WebSocket
            autoConnect: true,
            extraHeaders: {
                'Authorization': `Bearer ${token}`
            }
        });

        socket.on('connect', () => {
            console.log('[WebSocket] ‚úÖ ËøûÊé•ÊàêÂäü! ID:', socket.id);
        });

        socket.on('connect_error', (error) => {
            console.error('[WebSocket] üî¥ ËøûÊé•Â§±Ë¥•:', error.message);
            console.error('[WebSocket] ÈîôËØØËØ¶ÊÉÖ:', error);

            // Â∞ùËØïËé∑ÂèñÊõ¥Â§öÈîôËØØ‰ø°ÊÅØ
            if (error.type === 'TransportError') {
                console.error('[WebSocket] ‰º†ËæìÈîôËØØ:', error.description);
            } else if (error.type === 'UnauthorizedError') {
                console.error('[WebSocket] ËÆ§ËØÅÂ§±Ë¥•:', error.message);
            }
        });

        socket.on('disconnect', (reason) => {
            console.log('[WebSocket] üü† Êñ≠ÂºÄËøûÊé•:', reason);

            if (reason === 'io server disconnect') {
                console.log('[WebSocket] ÊúçÂä°Á´Ø‰∏ªÂä®Êñ≠ÂºÄ');
            } else if (reason === 'io client disconnect') {
                console.log('[WebSocket] ÂÆ¢Êà∑Á´Ø‰∏ªÂä®Êñ≠ÂºÄ');
            }
        });

        socket.on('reconnect_attempt', (attempt) => {
            console.log(`[WebSocket] üîÑ ÈáçËøûÂ∞ùËØï (${attempt}/5)`);
        });

        socket.on('reconnect', (attempt) => {
            console.log(`[WebSocket] ‚úÖ ÈáçËøûÊàêÂäü! Â∞ùËØïÊ¨°Êï∞: ${attempt}`);
        });

        socket.on('reconnect_error', (error) => {
            console.error('[WebSocket] üî¥ ÈáçËøûÂ§±Ë¥•:', error.message);
        });

        socket.on('reconnect_failed', () => {
            console.error('[WebSocket] ‚ùå ÈáçËøûÂÆåÂÖ®Â§±Ë¥•ÔºåÂÅúÊ≠¢Â∞ùËØï');
        });

        // ÁõëÂê¨ÊâÄÊúâ‰∫ã‰ª∂ÔºàË∞ÉËØïÁî®Ôºâ
        socket.onAny((event, ...args) => {
            console.log(`[WebSocket] üì§ Êî∂Âà∞‰∫ã‰ª∂: ${event}`, args);
        });
        function showNotification(message) {
            // ÂàõÂª∫ÈÄöÁü•ÂºπÁ™ó
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '15px';
            notification.style.background = '#4CAF50';
            notification.style.color = 'white';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '1000';
            notification.innerHTML = `
      <h3>${message.title}</h3>
      <p>${message.content}</p>
    `;

            document.body.appendChild(notification);

            // 3ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>

</html>